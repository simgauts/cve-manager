from app import db
from app.models.cve import Cve
from app.forms.cve import EditCveForm
from flask import current_app, Blueprint, render_template, request, flash, redirect, url_for
from flask_login import login_required

cve = Blueprint('cve', __name__, url_prefix='/cve')

@cve.route('/edit', methods=['GET', 'POST'])
@cve.route('/edit/<int:id>', methods=['GET', 'POST'])
@login_required
def edit(id=None):
    form = EditCveForm()
    if form.validate_on_submit():
        if id is None:
            cve = Cve(
                identifier=form.identifier.data,
                description=form.description.data,
                extra_description=form.extra_description.data
            )
            db.session.add(cve)
        else:
            cve = Cve.query.get(id)
            cve.identifier = form.identifier.data
            cve.description = form.description.data
            cve.extra_description = form.extra_description.data

        db.session.commit()
        flash('Your changes have been saved.')
        return redirect(url_for('home.index'))
    elif request.method == 'GET':
        if id is not None:
            cve = Cve.query.get(id)
            if cve is not None:
                form.identifier.data = cve.identifier
                form.description.data = cve.description
                form.extra_description.data = cve.extra_description
    return render_template('edit_cve.html', title='Add CVE',
                           form=form)